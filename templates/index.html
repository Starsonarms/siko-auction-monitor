{% extends "base.html" %}

{% block title %}Dashboard - Siko Auction Monitor{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h2 class="mb-2" style="color: var(--color-blue-green);">{{ stats.total_search_words }}</h2>
                <small class="text-muted">Search Words</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h2 class="mb-2" style="color: var(--color-sky-blue);">{{ config.check_interval_minutes }}m</h2>
                <small class="text-muted">Check Interval</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <span class="status-indicator status-green me-2" id="ha-status"></span>
                    <h2 class="mb-0" style="color: var(--color-blue-green);" id="ha-status-text">OK</h2>
                </div>
                <small class="text-muted">Home Assistant</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <h2 class="mb-2" style="color: var(--color-yellow);">{{ config.urgent_notification_threshold_minutes }}m</h2>
                <small class="text-muted">Urgent Threshold</small>
            </div>
        </div>
    </div>
</div>

<!-- Management & Current Auctions -->
<div class="row mb-3">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list"></i> Search Words</span>
                <button class="btn btn-sm btn-link p-0 text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Enter plain text (e.g. 'gitarr') or quoted phrases for exact matches (e.g. '&quot;vintage tools&quot;')">
                    <i class="fas fa-question-circle"></i>
                </button>
            </div>
            <div class="card-body">
                <form id="addWordForm" onsubmit="addSearchWord(); return false;" class="mb-3">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="searchWord" placeholder="e.g. gitarr or &quot;vintage tools&quot;" required>
                        <button type="submit" class="btn" id="addSearchBtn" style="background-color: var(--color-blue-green); color: white;">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        üí° <strong>Plain text</strong> matches any word ‚Ä¢ <strong>&quot;Quotes&quot;</strong> match exact phrase
                    </small>
                    <!-- Debug test button -->
                    <button type="button" class="btn btn-sm btn-warning" onclick="console.log('Test button clicked'); alert('Onclick works!')" style="display:none;" id="test-onclick">Test</button>
                </form>
                <div id="search-words-list">
                    {% if search_words %}
                        {% for word in search_words %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-1 bg-light rounded" id="search-word-{{ loop.index0 }}">
                            <span class="small"><i class="fas fa-search text-muted me-1"></i>{{ word }}</span>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-search-word" data-word="{{ word }}" data-index="{{ loop.index0 }}" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-muted text-center py-2">
                            <i class="fas fa-search fa-lg mb-1"></i><br>
                            <small>No search words configured.<br>Add some to start monitoring!</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-tools"></i> Tests
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 mb-2">
                    <button class="btn btn-outline btn-sm" style="border-color: var(--color-blue-green); color: var(--color-blue-green);" onclick="testScraper()">
                        <i class="fas fa-spider"></i> Test Scraper
                    </button>
                    <button class="btn btn-outline btn-sm" style="border-color: var(--color-blue-green); color: var(--color-blue-green);" onclick="testHomeAssistant()">
                        <i class="fas fa-home"></i> Test HA
                    </button>
                </div>
                <div id="test-results"></div>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span id="auction-header" class="small"><i class="fas fa-hammer"></i> Loading...</span>
                <div class="d-flex align-items-center gap-2">
                    <small id="last-updated" class="text-muted">Loading...</small>
                    <button class="btn btn-sm btn-outline" style="border-color: var(--color-blue-green); color: var(--color-blue-green);" onclick="refreshAuctions(event)" title="Refresh">
                        <i class="fas fa-sync"></i>
                    </button>
                    <a href="/auctions" class="btn btn-sm" style="background-color: var(--color-blue-green); color: white;" title="View All">
                        <i class="fas fa-eye"></i>
                    </a>
                </div>
            </div>
            <div class="card-body p-2" style="max-height: 400px; overflow-y: auto;">
                <div id="current-auctions">
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-spinner fa-spin fa-lg mb-2"></i><br>
                        <small>Loading auctions...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function addSearchWord() {
        const word = document.getElementById('searchWord').value.trim();
        console.log('addSearchWord called with:', word);
        
        if (!word) {
            console.log('Empty word, returning');
            return;
        }
        
        // Show loading state with animation
        const btn = document.getElementById('addSearchBtn');
        const originalHtml = btn.innerHTML;
        const originalBg = btn.style.backgroundColor;
        console.log('Setting button to loading state');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.style.transition = 'all 0.15s ease';
        btn.disabled = true;

        fetch('/api/search-words', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({word: word})
        })
        .then(response => {
            console.log('Add search word response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Add search word response data:', data);
            
            if (data.status === 'success') {
                console.log('Success! Showing success state');
                // Show success state briefly
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.style.backgroundColor = '#28a745';
                
                // Clear input
                document.getElementById('searchWord').value = '';
                
                // Clear cache to force fresh data
                try {
                    localStorage.removeItem('auctionData');
                } catch (e) {
                    console.log('Could not clear cache:', e);
                }
                
                // Update the search words list
                updateSearchWordsList();
                
                // Refresh auctions with new search term
                refreshAuctions(null);
                
                // Reset button after brief success display
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.style.backgroundColor = 'var(--color-blue-green)';
                    btn.disabled = false;
                }, 600);
            } else {
                alert('Error: ' + data.error);
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        })
        .catch(error => {
            alert('Error: ' + error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        });
    }

    function updateSearchWordsList() {
        // Fetch current search words and update the list
        fetch('/api/search-words')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const searchWordsList = document.getElementById('search-words-list');
                const searchWords = data.search_words || [];
                
                if (searchWords.length === 0) {
                    searchWordsList.innerHTML = `
                        <div class="text-muted text-center py-2">
                            <i class="fas fa-search fa-lg mb-1"></i><br>
                            <small>No search words configured.<br>Add some to start monitoring!</small>
                        </div>
                    `;
                } else {
                    let html = '';
                    searchWords.forEach((word, index) => {
                        const escapedWord = word.replace(/"/g, '&quot;');
                        html += `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-1 bg-light rounded" id="search-word-${index}">
                                <span class="small"><i class="fas fa-search text-muted me-1"></i>${word}</span>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-search-word" data-word="${escapedWord}" data-index="${index}" title="Remove">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                    });
                    searchWordsList.innerHTML = html;
                    
                    // Reattach event listeners
                    attachRemoveListeners();
                }
                
                // Update the stats counter if it exists
                const statsElement = document.querySelector('.card-body h2[style*="color-blue-green"]');
                if (statsElement) {
                    statsElement.textContent = searchWords.length;
                }
            }
        })
        .catch(error => {
            console.error('Error updating search words list:', error);
        });
    }
    
    function attachRemoveListeners() {
        console.log('Attaching remove listeners');
        document.querySelectorAll('.remove-search-word').forEach(button => {
            button.addEventListener('click', function() {
                const word = this.getAttribute('data-word');
                const index = parseInt(this.getAttribute('data-index'));
                console.log('Remove button clicked:', word, index);
                removeSearchWord(word, index);
            });
        });
    }
    
    function removeSearchWord(word, index) {
        console.log('removeSearchWord called with word:', word, 'index:', index);
        
        // Show immediate fade-out animation
        const element = document.getElementById(`search-word-${index}`);
        console.log('Found element:', element);
        
        if (element) {
            element.style.transition = 'all 0.2s ease';
            element.style.opacity = '0.3';
            element.style.transform = 'scale(0.95)';
        }
        
        const url = `/api/search-words/${encodeURIComponent(word)}`;
        console.log('Deleting search word at URL:', url);
        
        fetch(url, {
            method: 'DELETE'
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            
            if (data.status === 'success') {
                // Immediately remove the element
                if (element) {
                    element.style.height = element.offsetHeight + 'px';
                    setTimeout(() => {
                        element.style.height = '0';
                        element.style.marginBottom = '0';
                        element.style.paddingTop = '0';
                        element.style.paddingBottom = '0';
                        element.style.overflow = 'hidden';
                    }, 10);
                    setTimeout(() => {
                        element.remove();
                    }, 250);
                }
                
                // Show brief success message
                showTemporaryMessage(`‚úì Removed "${word}"`, 'success');
                
                // Clear cache to force fresh data
                try {
                    localStorage.removeItem('auctionData');
                } catch (e) {
                    console.log('Could not clear cache:', e);
                }
                
                // Update the search words list after animation
                setTimeout(() => {
                    updateSearchWordsList();
                }, 300);
                
                // Refresh auctions with remaining search terms
                refreshAuctions(null);
            } else {
                console.error('Error removing search word:', data.error);
                alert('Error: ' + (data.error || 'Unknown error'));
                if (element) {
                    element.style.opacity = '1';
                }
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('Error: ' + error);
            if (element) {
                element.style.opacity = '1';
            }
        });
    }
    
    function testScraper() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;

        fetch('/api/test-scraper')
        .then(response => response.json())
        .then(data => {
            // System message only
            let systemHtml = `
                <div class="alert alert-${data.status === 'success' ? 'success' : (data.status === 'warning' ? 'warning' : 'danger')}">
                    <strong>Scraper Test:</strong> ${data.message || data.error}
                    ${data.auctions_found !== undefined ? `<br><small>Found ${data.auctions_found} auctions</small>` : ''}
                </div>
            `;
            document.getElementById('test-results').innerHTML = systemHtml;
        })
        .catch(error => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Scraper Test Failed:</strong> ${error}
                </div>
            `;
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    function testHomeAssistant() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;

        fetch('/api/test-homeassistant')
        .then(response => response.json())
        .then(data => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-${data.status === 'success' ? 'success' : 'danger'}">
                    <strong>Home Assistant Test:</strong> ${data.message || data.error}
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Home Assistant Test Failed:</strong> ${error}
                </div>
            `;
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }


    function updateAuctionResults(auctions, hiddenCount = 0) {
        console.log('updateAuctionResults called with:', auctions, hiddenCount);
        const container = document.getElementById('current-auctions');
        const header = document.getElementById('auction-header');
        
        // Force clear any loading state first
        if (container) {
            container.innerHTML = '';
            console.log('Cleared container content before update');
        }
        
        if (!container) {
            console.error('Container current-auctions not found!');
            return;
        }
        if (!header) {
            console.error('Header auction-header not found!');
            return;
        }
        
        // Show all auctions (visible and hidden) but with different styling
        let allAuctions = auctions || [];
        console.log('All auctions:', allAuctions);
        
        // Sort by time left (ascending - ending soonest first), then by search term
        allAuctions.sort((a, b) => {
            const aTime = a.minutes_remaining !== null && a.minutes_remaining !== undefined ? a.minutes_remaining : Number.MAX_VALUE;
            const bTime = b.minutes_remaining !== null && b.minutes_remaining !== undefined ? b.minutes_remaining : Number.MAX_VALUE;
            if (aTime !== bTime) return aTime - bTime;
            // If time is equal, sort by search term
            return (a.found_via || '').localeCompare(b.found_via || '');
        });
        console.log('Sorted auctions by time left');
        const visibleCount = allAuctions.filter(auction => !auction.is_hidden).length;
        const actualHiddenCount = allAuctions.filter(auction => auction.is_hidden).length;
        
        // Update header with total count and hidden count
        let headerHtml = `<i class="fas fa-hammer"></i> Current Auctions (${allAuctions.length})`;
        if (actualHiddenCount > 0) {
            headerHtml += `<br><small class="text-muted">${actualHiddenCount} hidden</small>`;
        }
        header.innerHTML = headerHtml;
        
        if (!allAuctions || allAuctions.length === 0) {
            container.innerHTML = `
                <div class="text-muted text-center">
                    <i class="fas fa-search"></i><br>
                    No auctions currently match your search terms<br>
                    <small>Try adding more search terms or check back later</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        for (let auction of allAuctions) {
            const isHidden = auction.is_hidden || false;
            const hiddenClass = isHidden ? 'border-warning' : '';
            const hiddenStyle = isHidden ? 'style="background-color: #FFB70320; border-color: var(--color-yellow);"' : '';
            const hiddenBadge = isHidden ? '<span class="badge text-dark me-1" style="background-color: var(--color-yellow);"><small><i class="fas fa-eye-slash"></i></small></span>' : '';
            const titleClass = isHidden ? 'text-muted' : '';
            const auctionTitle = auction.title || 'No title';
            const escapedTitle = auctionTitle.replace(/'/g, "\\'").replace(/"/g, '\\"');
            const truncatedTitle = auctionTitle.length > 50 ? auctionTitle.substring(0, 50) + '...' : auctionTitle;
            
            html += '<div class="border-bottom py-1 px-1 mb-1 ' + hiddenClass + '" ' + hiddenStyle + '>' +
                '<div class="d-flex justify-content-between align-items-start">' +
                '<div class="flex-grow-1">' +
                hiddenBadge +
                '<a href="' + (auction.url || '#') + '" target="_blank" class="text-decoration-none ' + titleClass + ' small fw-bold" style="' + (isHidden ? '' : 'color: var(--color-blue-green);') + '">' +
                truncatedTitle +
                '</a>' +
                '<div class="text-muted" style="font-size: 0.75rem;">' +
                'üí∞ ' + (auction.current_bid || 'N/A') + ' ‚Ä¢ ' +
                '‚è∞ ' + (auction.time_left || 'N/A') + ' ‚Ä¢ ' +
                'üîç ' + (auction.found_via || 'Unknown') +
                '</div>' +
                '</div>' +
                (isHidden ? '<button class="btn btn-xs btn-outline-success" onclick="unhideAuction(\'' + (auction.id || '') + '\', \'' + escapedTitle + '\')" title="Unhide"><i class="fas fa-eye"></i></button>' : '') +
                '</div>' +
                '</div>';
        }
        
        console.log('About to set container innerHTML, html length:', html.length);
        console.log('Current container content before update:', container.innerHTML.substring(0, 50) + '...');
        container.innerHTML = html;
        console.log('Container innerHTML set successfully');
        console.log('New container content length:', container.innerHTML.length);
        console.log('Container children count:', container.children.length);
        console.log('First 50 chars of new content:', container.innerHTML.substring(0, 50) + '...');
    }
    
    function unhideAuction(auctionId, auctionTitle) {
        if (!auctionId) {
            alert('Unable to unhide auction: No auction ID available');
            return;
        }
        
        fetch('/api/blacklist/' + encodeURIComponent(auctionId), {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showTemporaryMessage(data.message, 'success');
                
                // Refresh the auctions to show the unhidden one
                refreshAuctions(null);
            } else {
                alert('Error unhiding auction: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unhiding auction: ' + error);
        });
    }
    
    function showTemporaryMessage(message, type) {
        // Create a temporary alert for dashboard
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'warning'} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 2 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 2000);
    }
    
    let isRefreshing = false;
    
    function refreshAuctions(event) {
        console.log('refreshAuctions called with event:', event);
        
        // Prevent multiple simultaneous refreshes
        if (isRefreshing) {
            console.log('Already refreshing, ignoring click completely');
            return;
        }
        
        isRefreshing = true;
        console.log('Starting refresh, flag set to true');
        let button = null;
        
        if (event && event.target) {
            // Find the actual button element (might be clicking on the icon)
            button = event.target.closest('button');
            if (button) {
                // Clear any existing content first, then set spinner
                button.innerHTML = '';
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
                console.log('Button cleared and set to spinner state');
            } else {
                console.error('Could not find button element');
            }
        }
        
        // Show loading in auction results
        const auctionsContainer = document.getElementById('current-auctions');
        console.log('Setting loading state in content area');
        if (auctionsContainer) {
            auctionsContainer.innerHTML = `
                <div class="text-muted text-center">
                    <i class="fas fa-spinner fa-spin"></i> Loading auctions...
                </div>
            `;
        } else {
            console.error('current-auctions element not found!');
        }
        
        fetch('/api/test-scraper/dashboard')
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers.get('content-type'));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Not JSON - probably an error page
                return response.text().then(text => {
                    console.log('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server returned HTML instead of JSON - check server logs');
                });
            }
            
            return response.json();
        })
        .then(data => {
            console.log('API response:', data);
            
            if (!data) {
                console.error('No data received from API');
                throw new Error('No data received from server');
            }
            
            // Handle test-scraper/dashboard response
            console.log('About to call updateAuctionResults with:', data.auctions);
            updateAuctionResults(data.auctions || [], data.hidden_count || 0);
            
            // Cache auction data for reuse
            if (data.status === 'success' && data.auctions) {
                const cacheData = {
                    auctions: data.auctions,
                    timestamp: Date.now(),
                    total_auctions: data.auctions_found || data.auctions.length,
                    search_words_tested: data.search_words_tested || [],
                    hidden_count: data.hidden_count || 0
                };
                try {
                    localStorage.setItem('auctionData', JSON.stringify(cacheData));
                    console.log('Cached auction data, valid for', {{ config.check_interval_minutes }}, 'minutes');
                } catch (e) {
                    console.log('Could not cache auction data:', e);
                }
            }
            
            // Update timestamp
            const now = new Date();
            document.getElementById('last-updated').textContent = `Updated: ${now.toLocaleTimeString()}`;
        })
        .catch(error => {
            console.error('Fetch error details:', error);
            console.error('Error type:', typeof error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            
            const container = document.getElementById('current-auctions');
            if (container) {
                container.innerHTML = `
                    <div class="text-danger text-center">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error loading auctions: ${error}<br>
                        <small>Check console for details</small>
                    </div>
                `;
            }
            
            // Update header and timestamp with error
            const header = document.getElementById('auction-header');
            const timestamp = document.getElementById('last-updated');
            if (header) header.innerHTML = '<i class="fas fa-hammer"></i> Current Auctions (0)';
            if (timestamp) timestamp.textContent = 'Error loading';
        })
        .finally(() => {
            isRefreshing = false; // Reset the flag
            if (button) {
                // Clear and restore the original refresh icon
                button.innerHTML = '';
                button.innerHTML = '<i class="fas fa-sync"></i>';
                button.disabled = false;
                console.log('Button cleared and restored to sync state, innerHTML:', button.innerHTML);
            }
            console.log('refreshAuctions completed, flag reset');
        });
    }
    
    // Check if we have cached auction data first
    function loadCachedAuctions() {
        console.log('loadCachedAuctions called');
        try {
            const cachedData = localStorage.getItem('auctionData');
            console.log('Cached data from localStorage:', cachedData);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                const cacheAge = Date.now() - data.timestamp;
                console.log('Cache age (ms):', cacheAge);
                
                // Use cached data if it's less than the check interval (config.check_interval_minutes)
                const maxCacheAge = {{ config.check_interval_minutes }} * 60 * 1000; // Convert to milliseconds
                
                if (cacheAge < maxCacheAge) {
                    console.log('Using cached auction data, age:', Math.floor(cacheAge / 1000), 'seconds');
                    
                    // Pass all auctions to updateAuctionResults (it will handle both visible and hidden display)
                    const allAuctions = data.auctions || [];
                    updateAuctionResults(allAuctions, 0);
                    
                    const cacheTime = new Date(data.timestamp);
                    document.getElementById('last-updated').textContent = `Updated: ${cacheTime.toLocaleTimeString()}`;
                    
                    return true; // Indicate we used cached data
                }
            }
        } catch (e) {
            console.log('Error loading cached auction data:', e);
        }
        return false; // No valid cached data
    }
    
    // Listen for storage changes (cache updates from other tabs/windows)
    window.addEventListener('storage', function(e) {
        // Only react to changes in the auctionData cache key
        if (e.key === 'auctionData' && e.newValue) {
            console.log('Detected cache update from another tab, refreshing auction list');
            
            try {
                const updatedData = JSON.parse(e.newValue);
                // Update the dashboard with the new cached data (shows both visible and hidden)
                const allAuctions = updatedData.auctions || [];
                updateAuctionResults(allAuctions, 0);
                
                // Update the timestamp
                const cacheTime = new Date(updatedData.timestamp);
                document.getElementById('last-updated').textContent = `Updated: ${cacheTime.toLocaleTimeString()}`;
                
                console.log('Dashboard updated with cached data from storage event');
            } catch (error) {
                console.log('Error parsing updated cache data:', error);
            }
        }
    });
    
    // Auto-load auctions when page loads - try cache first
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded fired');
        
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Attach remove button listeners
        attachRemoveListeners();
        
        // Try to load from cache first
        const usedCache = loadCachedAuctions();
        console.log('Used cache:', usedCache);
        
        if (!usedCache) {
            // No cached data or cache is too old, fetch fresh data
            console.log('No cache, refreshing auctions');
            document.getElementById('last-updated').textContent = 'Loading...';
            document.getElementById('auction-header').innerHTML = '<i class="fas fa-hammer"></i> Current Auctions';
            refreshAuctions(null); // Pass null instead of undefined
        }
    });
    
    // Manual refresh will always fetch fresh data
</script>
{% endblock %}

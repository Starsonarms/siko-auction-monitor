{% extends "base.html" %}

{% block title %}Dashboard - Siko Auction Monitor{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
        <p class="text-muted">Monitor and manage your auction search system</p>
    </div>
</div>

<!-- System Status -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">System Status</h4>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-primary">{{ stats.total_search_words }}</h2>
                <small class="text-muted">Search Words</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-info">{{ config.check_interval_minutes }}m</h2>
                <small class="text-muted">Check Interval</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="mb-2">
                    <span class="status-indicator status-green" id="ha-status"></span>
                    <span id="ha-status-text" class="text-success">Connected</span>
                </div>
                <small class="text-muted">Home Assistant</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h2 class="text-warning">{{ config.urgent_notification_threshold_minutes }}m</h2>
                <small class="text-muted">Urgent Threshold</small>
            </div>
        </div>
    </div>
</div>

<!-- Management -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">Management</h4>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list"></i> Search Words</span>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addWordModal">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
            <div class="card-body">
                <div id="search-words-list">
                    {% if search_words %}
                        {% for word in search_words %}
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                            <span><i class="fas fa-search text-muted me-2"></i>{{ word }}</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeSearchWord('{{ word }}')" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-muted text-center py-3">
                            <i class="fas fa-search fa-2x mb-2"></i><br>
                            No search words configured.<br>
                            <small>Add some to start monitoring!</small>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-tools"></i> System Tests
            </div>
            <div class="card-body">
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-primary" onclick="testScraper()">
                        <i class="fas fa-spider"></i> Test Scraper
                    </button>
                    <button class="btn btn-outline-success" onclick="testHomeAssistant()">
                        <i class="fas fa-home"></i> Test Home Assistant
                    </button>
                </div>
                <div id="test-results"></div>
            </div>
        </div>
    </div>
</div>

<!-- Current Auctions -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-3">Current Auctions</h4>
    </div>
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span id="auction-header"><i class="fas fa-hammer"></i> Loading...</span>
                <div class="d-flex align-items-center gap-3">
                    <small id="last-updated" class="text-muted">Loading...</small>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshAuctions(event)">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <a href="/auctions" class="btn btn-sm btn-primary">
                        <i class="fas fa-eye"></i> View All
                    </a>
                </div>
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <div id="current-auctions">
                    <div class="text-muted text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i><br>
                        Loading current auctions...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Search Word Modal -->
<div class="modal fade" id="addWordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Search Word</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addWordForm" onsubmit="addSearchWord(); return false;">
                    <div class="mb-3">
                        <label for="searchWord" class="form-label">Search Word</label>
                        <input type="text" class="form-control" id="searchWord" placeholder="e.g., antique, vintage, lego technic" required>
                        <div class="form-text">This word will be searched in auction titles, descriptions, and items.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSearchWord()">Add Word</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function addSearchWord() {
        const word = document.getElementById('searchWord').value.trim();
        if (!word) {
            alert('Please enter a search word');
            return;
        }

        fetch('/api/search-words', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({word: word})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addWordModal'));
                if (modal) modal.hide();
                // Clear input
                document.getElementById('searchWord').value = '';
                // Reload page to show new word
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }

    function removeSearchWord(word) {
        fetch(`/api/search-words/${encodeURIComponent(word)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }

    function testScraper() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;

        fetch('/api/test-scraper')
        .then(response => response.json())
        .then(data => {
            // System message only
            let systemHtml = `
                <div class="alert alert-${data.status === 'success' ? 'success' : (data.status === 'warning' ? 'warning' : 'danger')}">
                    <strong>Scraper Test:</strong> ${data.message || data.error}
                    ${data.auctions_found !== undefined ? `<br><small>Found ${data.auctions_found} auctions</small>` : ''}
                </div>
            `;
            document.getElementById('test-results').innerHTML = systemHtml;
        })
        .catch(error => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Scraper Test Failed:</strong> ${error}
                </div>
            `;
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }

    function testHomeAssistant() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
        button.disabled = true;

        fetch('/api/test-homeassistant')
        .then(response => response.json())
        .then(data => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-${data.status === 'success' ? 'success' : 'danger'}">
                    <strong>Home Assistant Test:</strong> ${data.message || data.error}
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('test-results').innerHTML = `
                <div class="alert alert-danger">
                    <strong>Home Assistant Test Failed:</strong> ${error}
                </div>
            `;
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }


    function updateAuctionResults(auctions, hiddenCount = 0) {
        const container = document.getElementById('current-auctions');
        const header = document.getElementById('auction-header');
        
        // Update header with count and hidden count on separate lines
        const count = auctions ? auctions.length : 0;
        let headerHtml = `<i class="fas fa-hammer"></i> Current Auctions (${count})`;
        if (hiddenCount > 0) {
            headerHtml += `<br><small class="text-muted">${hiddenCount} hidden</small>`;
        }
        header.innerHTML = headerHtml;
        
        if (!auctions || auctions.length === 0) {
            container.innerHTML = `
                <div class="text-muted text-center">
                    <i class="fas fa-search"></i><br>
                    No auctions currently match your search terms<br>
                    <small>Try adding more search terms or check back later</small>
                </div>
            `;
            return;
        }
        
        let html = '';
        for (let auction of auctions) {
            const isHidden = auction.is_hidden || false;
            const hiddenClass = isHidden ? 'bg-warning bg-opacity-25 border-warning' : 'bg-light';
            const hiddenBadge = isHidden ? '<span class="badge bg-warning text-dark me-1"><i class="fas fa-eye-slash"></i> Hidden</span>' : '';
            
            html += `
                <div class="border rounded p-2 mb-2 ${hiddenClass}">
                    <div class="mb-1 d-flex justify-content-between align-items-start">
                        <div>
                            ${hiddenBadge}
                            <strong><a href="${auction.url}" target="_blank" class="text-decoration-none ${isHidden ? 'text-muted' : 'text-primary'}">${auction.title}</a></strong>
                        </div>
                        ${isHidden ? `<button class="btn btn-sm btn-outline-success" onclick="unhideAuction('${auction.id}', '${auction.title.replace(/'/g, "\\'").replace(/"/g, '\\"')}')"><i class="fas fa-eye"></i></button>` : ''}
                    </div>
                    <div class="small ${isHidden ? 'text-muted' : 'text-muted'}">
                        💰 ${auction.current_bid}<br>
                        🏷️ ${auction.reserve_price}<br>
                        ⏰ ${auction.time_left}<br>
                        🔍 "${auction.found_via}"
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    function unhideAuction(auctionId, auctionTitle) {
        if (!auctionId) {
            alert('Unable to unhide auction: No auction ID available');
            return;
        }
        
        fetch(`/api/blacklist/${encodeURIComponent(auctionId)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Show success message
                showTemporaryMessage(data.message, 'success');
                
                // Refresh the auctions to show the unhidden one
                refreshAuctions();
            } else {
                alert('Error unhiding auction: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unhiding auction: ' + error);
        });
    }
    
    function showTemporaryMessage(message, type) {
        // Create a temporary alert for dashboard
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'warning'} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }
    
    function refreshAuctions(event) {
        let button = null;
        let originalText = null;
        
        if (event && event.target) {
            button = event.target;
            originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
        }
        
        // Show loading in auction results
        document.getElementById('current-auctions').innerHTML = `
            <div class="text-muted text-center">
                <i class="fas fa-spinner fa-spin"></i> Loading auctions...
            </div>
        `;
        
        fetch('/api/test-scraper/dashboard')
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers.get('content-type'));
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                // Not JSON - probably an error page
                return response.text().then(text => {
                    console.log('Non-JSON response:', text.substring(0, 200));
                    throw new Error('Server returned HTML instead of JSON - check server logs');
                });
            }
            
            return response.json();
        })
        .then(data => {
            console.log('API response:', data);
            
            // Handle test-scraper/dashboard response
            updateAuctionResults(data.auctions || [], data.hidden_count || 0);
            
            // Cache auction data for reuse
            if (data.status === 'success' && data.auctions) {
                const cacheData = {
                    auctions: data.auctions,
                    timestamp: Date.now(),
                    total_auctions: data.auctions_found || data.auctions.length,
                    search_words_tested: data.search_words_tested || [],
                    hidden_count: data.hidden_count || 0
                };
                try {
                    localStorage.setItem('auctionData', JSON.stringify(cacheData));
                    console.log('Cached auction data, valid for', {{ config.check_interval_minutes }}, 'minutes');
                } catch (e) {
                    console.log('Could not cache auction data:', e);
                }
            }
            
            // Update timestamp
            const now = new Date();
            document.getElementById('last-updated').textContent = `Updated: ${now.toLocaleTimeString()}`;
        })
        .catch(error => {
            document.getElementById('current-auctions').innerHTML = `
                <div class="text-danger text-center">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Error loading auctions: ${error}
                </div>
            `;
            // Update header and timestamp with error
            document.getElementById('auction-header').innerHTML = '<i class="fas fa-hammer"></i> Current Auctions (0)';
            document.getElementById('last-updated').textContent = 'Error loading';
        })
        .finally(() => {
            if (button) {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        });
    }
    
    // Check if we have cached auction data first
    function loadCachedAuctions() {
        try {
            const cachedData = localStorage.getItem('auctionData');
            if (cachedData) {
                const data = JSON.parse(cachedData);
                const cacheAge = Date.now() - data.timestamp;
                
                // Use cached data if it's less than the check interval (config.check_interval_minutes)
                const maxCacheAge = {{ config.check_interval_minutes }} * 60 * 1000; // Convert to milliseconds
                
                if (cacheAge < maxCacheAge) {
                    console.log('Using cached auction data, age:', Math.floor(cacheAge / 1000), 'seconds');
                    updateAuctionResults(data.auctions || [], data.hidden_count || 0);
                    
                    const cacheTime = new Date(data.timestamp);
                    document.getElementById('last-updated').textContent = `Updated: ${cacheTime.toLocaleTimeString()}`;
                    document.getElementById('auction-header').innerHTML = `<i class="fas fa-hammer"></i> Current Auctions (${data.auctions ? data.auctions.length : 0})`;
                    
                    return true; // Indicate we used cached data
                }
            }
        } catch (e) {
            console.log('Error loading cached auction data:', e);
        }
        return false; // No valid cached data
    }
    
    // Auto-load auctions when page loads - try cache first
    document.addEventListener('DOMContentLoaded', function() {
        // Try to load from cache first
        const usedCache = loadCachedAuctions();
        
        if (!usedCache) {
            // No cached data or cache is too old, fetch fresh data
            document.getElementById('last-updated').textContent = 'Loading...';
            document.getElementById('auction-header').innerHTML = '<i class="fas fa-hammer"></i> Current Auctions';
            refreshAuctions();
        }
    });
    
    // Manual refresh will always fetch fresh data
</script>
{% endblock %}
